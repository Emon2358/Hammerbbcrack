<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hammerbbcrack Ultimate</title>
  <meta name="referrer" content="no-referrer">
  <style>
    :root {
      --bg: #fff; --fg: #333; --accent: #3498db; --error: #e74c3c;
    }
    [data-theme="dark"] {
      --bg: #121212; --fg: #ddd; --accent: #4e9af1; --error: #e74c3c;
    }
    body {
      margin:0; font-family:Arial,sans-serif;
      background:var(--bg); color:var(--fg);
    }
    #toolbar {
      display:flex; flex-wrap:wrap; gap:0.5rem; padding:1rem;
      background:var(--bg);
    }
    #toolbar input, #toolbar button {
      padding:0.5rem; font-size:1rem;
    }
    #toolbar input { flex:1 1 200px; }
    #toolbar .small { flex:0 0 auto; }
    #progress {
      position:fixed; top:0; left:0; width:100%; height:4px;
      background:#eee; z-index:1000;
    }
    #bar {
      width:0; height:100%; background:var(--accent);
      transition:width 0.2s;
    }
    #status {
      position:fixed; top:4px; left:50%; transform:translateX(-50%);
      padding:0.2rem 0.5rem; background:var(--accent); color:#fff;
      font-size:0.9rem; border-radius:2px; opacity:0; transition:opacity 0.3s;
      z-index:1001;
    }
    #errorBanner {
      position:fixed; top:0; left:0; width:100%;
      background:var(--error); color:#fff; text-align:center;
      padding:0.5rem; display:none; z-index:1002;
    }
    #content {
      padding:1rem; margin-top:0.5rem;
    }
    img { max-width:100%; margin:0.5rem 0; }
    .thumbnail { max-height:200px; cursor:pointer; }
    #darkToggle { position:fixed; bottom:1rem; right:1rem;
      padding:0.5rem; background:var(--accent); color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
  </style>
</head>
<body data-theme="light">
  <div id="errorBanner"></div>
  <div id="toolbar">
    <input id="urlInput" type="url" placeholder="https://example.com" autofocus>
    <input id="selectorInput" type="text" placeholder="CSS„Çª„É¨„ÇØ„Çø„Éº (‰æã:.main)">
    <button id="goButton">Go</button>
    <button id="backButton" class="small" disabled>‚óÄÔ∏é</button>
    <button id="forwardButton" class="small" disabled>‚ñ∂Ô∏é</button>
    <button id="downloadButton" class="small">üì• Save HTML</button>
  </div>
  <div id="progress"><div id="bar"></div></div>
  <div id="status"></div>
  <div id="content">„Åì„Åì„Å´„Éö„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô‚Ä¶</div>
  <button id="darkToggle">Toggle Dark</button>

  <!-- Readability„ÅÆ„ÅøÂ§ñÈÉ®Ë™≠„ÅøËæº„Åø -->
  <script src="https://unpkg.com/@mozilla/readability@0.4.4/Readability.js"></script>
  <script>
  (async()=>{
    // Ë§áÊï∞„Éó„É≠„Ç≠„Ç∑Ôºã„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÔºã„É≠„Éº„Ç´„É´„Ç≠„É£„ÉÉ„Ç∑„É•
    const PROXIES = [
      'https://api.allorigins.win/raw?url=',
      'https://corsproxy.io/?',
      'https://thingproxy.freeboard.io/fetch/'
    ];
    const TIMEOUT = 15000;
    const TTL = 5 * 60 * 1000;
    const BLACKLIST = ['ads.example','tracker.site','malicious.com'];
    const EASYLIST = [
      /googlesyndication\.com/, /doubleclick\.net/, /adservice\.google\.com/,
      /adsystem\.com/, /analytics\.js/
    ];
    let blockCount = 0;

    // Ë¶ÅÁ¥†
    const urlInput = document.getElementById('urlInput');
    const selectorInput = document.getElementById('selectorInput');
    const goBtn = document.getElementById('goButton');
    const backBtn = document.getElementById('backButton');
    const fwdBtn = document.getElementById('forwardButton');
    const dlBtn = document.getElementById('downloadButton');
    const bar = document.getElementById('bar');
    const status = document.getElementById('status');
    const errBanner = document.getElementById('errorBanner');
    const content = document.getElementById('content');
    const root = document.documentElement;

    // „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ
    function setTheme(t){
      root.setAttribute('data-theme', t);
      localStorage.theme = t;
    }
    document.getElementById('darkToggle').onclick = ()=>{
      setTheme(root.getAttribute('data-theme')==='dark' ? 'light' : 'dark');
    };
    setTheme(localStorage.theme || (matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light'));

    // „Çπ„ÉÜ„Éº„Çø„Çπ
    function showStatus(msg, duration=1500){
      status.textContent = msg;
      status.style.opacity = '1';
      clearTimeout(status._tid);
      status._tid = setTimeout(()=> status.style.opacity = '0', duration);
    }
    function showError(msg){
      errBanner.textContent = msg;
      errBanner.style.display = 'block';
      setTimeout(()=> errBanner.style.display = 'none', 4000);
    }

    // „É≠„Éº„Ç´„É´„Ç≠„É£„ÉÉ„Ç∑„É•ÂèñÂæóÔºè‰øùÂ≠ò
    function getCache(key){
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (Date.now() - obj.ts > TTL) {
          localStorage.removeItem(key);
          return null;
        }
        return obj.html;
      } catch { return null; }
    }
    function setCache(key, html){
      try {
        localStorage.setItem(key, JSON.stringify({ ts: Date.now(), html }));
      } catch {}
    }

    // „Éï„Çß„ÉÉ„ÉÅÔºã„Ç≠„É£„ÉÉ„Ç∑„É•Ôºã„Éï„Ç£„É´„Çø
    async function fetchWithFallback(rawUrl){
      const key = 'c_' + rawUrl;
      const cached = getCache(key);
      if (cached) return cached;

      const host = new URL(rawUrl).hostname;
      if (BLACKLIST.includes(host)) throw new Error('Domain blocked');

      let lastErr;
      for (const proxy of PROXIES) {
        try {
          const controller = new AbortController();
          const timeout = setTimeout(()=> controller.abort(), TIMEOUT);
          showStatus(`Fetching via ${new URL(proxy).hostname}‚Ä¶`);
          const res = await fetch(proxy + encodeURIComponent(rawUrl), {
            credentials: 'omit',
            referrerPolicy: 'no-referrer',
            signal: controller.signal
          });
          clearTimeout(timeout);
          if (!res.ok) throw new Error(res.status + ' ' + res.statusText);

          // „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞„ÅßÂ∫ÉÂëä„Éñ„É≠„ÉÉ„ÇØ
          const reader = res.body.getReader();
          const len = +res.headers.get('Content-Length') || 0;
          let received = 0, chunks = [];
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const text = new TextDecoder().decode(value);
            if (EASYLIST.some(rx=>rx.test(text))) {
              blockCount++;
              showStatus(`Blocked ads: ${blockCount}`);
              continue;
            }
            chunks.push(value);
            received += value.length;
            if (len) bar.style.width = (received/len*100) + '%';
          }

          const html = new TextDecoder('utf-8').decode(new Uint8Array(chunks.flat()));
          setCache(key, html);
          bar.style.width = '0%';
          return html;
        } catch (err) {
          lastErr = err;
          bar.style.width = '0%';
        }
      }
      throw lastErr;
    }

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„Åø
    async function _loadPage(url, useReader){
      document.title = 'Loading‚Ä¶';
      content.innerHTML = '';
      try {
        const html = await fetchWithFallback(url);
        const doc = new DOMParser().parseFromString(html, 'text/html');
        document.title = doc.title || url;

        if (useReader) {
          const art = new Readability(doc).parse();
          if (art) {
            content.innerHTML = art.content;
            return;
          }
        }

        // base„Çø„Ç∞
        let base = doc.querySelector('base');
        if (!base) {
          base = doc.createElement('base');
          doc.head.insertBefore(base, doc.head.firstChild);
        }
        base.setAttribute('href', url);

        // src/href ‚Üí Áµ∂ÂØæÂåñ
        doc.querySelectorAll('[src],[href]').forEach(el => {
          const attr = el.hasAttribute('src') ? 'src' : 'href';
          const v = el.getAttribute(attr);
          if (v && !/^(https?:|\/\/|data:)/.test(v)) {
            el.setAttribute(attr, new URL(v, url).href);
          }
        });

        // ‰∏çË¶Å„Çø„Ç∞Èô§Âéª
        doc.querySelectorAll('meta[http-equiv],script,iframe').forEach(e=>e.remove());

        // CSS inline
        await Promise.all([...doc.querySelectorAll('link[rel=stylesheet]')].map(async l=>{
          try {
            const css = await fetch(PROXIES[0] + encodeURIComponent(l.href), {
              credentials: 'omit',
              referrerPolicy: 'no-referrer'
            }).then(r=>r.text());
            const s = document.createElement('style');
            s.textContent = css;
            l.replaceWith(s);
          } catch {}
        }));

        // „É°„Éá„Ç£„Ç¢„Å®„Éï„Ç©„Éº„É†
        doc.querySelectorAll('img').forEach(img=>{
          img.loading = 'lazy';
          img.classList.add('thumbnail');
          img.onclick = ()=> img.classList.toggle('thumbnail');
        });
        doc.querySelectorAll('video').forEach(v=>v.setAttribute('controls',''));
        doc.querySelectorAll('form').forEach(f=>{
          const abs = new URL(f.action||url, url).href;
          f.method = 'GET';
          f.action = '/';
          const i = document.createElement('input');
          i.type = 'hidden'; i.name = 'url'; i.value = abs;
          f.appendChild(i);
        });

        // „Çª„É¨„ÇØ„Çø„ÉºÊäΩÂá∫
        const sel = selectorInput.value.trim();
        const frag = sel
          ? (doc.querySelector(sel) || document.createTextNode('Ë©≤ÂΩì„Åô„ÇãË¶ÅÁ¥†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì')).cloneNode(true)
          : doc.body.cloneNode(true);
        content.appendChild(frag);

      } catch (err) {
        showError(err.message || 'Unknown error');
        content.textContent = 'Error: ' + err.message;
        document.title = 'Error';
      } finally {
        bar.style.width = '0%';
      }
    }

    // HTML„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    function downloadHTML(){
      const blob = new Blob([
        '<!DOCTYPE html>\n<html>'+document.documentElement.innerHTML+'</html>'
      ], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'snapshot.html';
      a.click();
    }

    // „Ç§„Éô„É≥„Éà
    goBtn.onclick = ()=>{
      const u = urlInput.value.trim();
      if (!u) return;
      history.pushState({u}, '', `?u=${encodeURIComponent(u)}`);
      _loadPage(u, false);
      backBtn.disabled = !history.state;
    };
    backBtn.onclick = ()=> history.back();
    fwdBtn.onclick = ()=> history.forward();
    dlBtn.onclick = downloadHTML;
    [urlInput, selectorInput].forEach(el=>{
      el.addEventListener('keyup', e=>{ if (e.key==='Enter') goBtn.click(); });
    });
    window.addEventListener('popstate', e=>{
      if (e.state && e.state.u) {
        urlInput.value = e.state.u;
        _loadPage(e.state.u, false);
      }
    });

    // ÂàùÂõûË™≠Ëæº
    (()=>{
      const p = new URLSearchParams(location.search);
      if (p.has('u')) {
        const u = p.get('u');
        urlInput.value = u;
        _loadPage(u, false);
        backBtn.disabled = !history.state;
      }
    })();
  })();
  </script>
</body>
</html>
